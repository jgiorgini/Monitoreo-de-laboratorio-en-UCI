<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Monitor de Laboratorios UCI (V13)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.7.1/dist/chart.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;500;700&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #f0f4f8; }
        .lab-input { min-height: 200px; resize: vertical; font-family: monospace; }
        .data-grid { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 1rem; }
        .loading-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255, 255, 255, 0.8); z-index: 10; display: flex; justify-content: center; align-items: center; }
        .uci-table-fixed th { position: sticky; top: 0; background-color: #bfdbfe; z-index: 5; }
    </style>
</head>
<body class="p-4">

<div id="app" class="max-w-7xl mx-auto bg-white p-6 rounded-xl shadow-2xl">
    <header class="mb-6 border-b pb-4">
        <h1 class="text-3xl font-bold text-blue-800">Monitor de Laboratorios UCI <span class="text-sm bg-indigo-300 px-2 py-0.5 rounded">V13 (Estabilidad Máxima)</span></h1>
        <p class="text-sm text-gray-500">Carga, Parsing Robusto y Seguimiento Diario por Paciente Crítico.</p>
    </header>

    <!-- CARGA DE DATOS -->
    <section class="mb-8 p-4 border rounded-lg bg-gray-50">
        <h2 class="text-xl font-semibold mb-3 text-gray-700">1. Carga de Laboratorio (Texto o PDF)</h2>
        <textarea id="labInput" class="lab-input w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500" placeholder="Pegue aquí el texto del laboratorio o arrastre un PDF..."></textarea>
        <div class="flex space-x-4 mt-3">
            <input type="file" id="pdfInput" accept="application/pdf" class="hidden">
            <label for="pdfInput" class="px-4 py-2 bg-blue-600 text-white font-medium rounded-lg cursor-pointer hover:bg-blue-700 transition duration-150">Cargar PDF (OCR/Digital)</label>
            <button onclick="processInput(document.getElementById('labInput').value)" class="px-6 py-2 bg-green-600 text-white font-medium rounded-lg hover:bg-green-700 transition duration-150">Procesar Texto y Guardar</button>
            <button onclick="clearInput()" class="px-4 py-2 bg-red-600 text-white font-medium rounded-lg hover:bg-red-700 transition duration-150">Limpiar Entrada</button>
        </div>
    </section>

    <!-- SELECCIÓN Y RESULTADOS -->
    <section class="mb-8 p-4 border rounded-lg">
        <h2 class="text-xl font-semibold mb-3 text-gray-700">2. Exploración y Salida</h2>
        <div class="data-grid mb-4">
            <div>
                <label for="patientSelector" class="block text-sm font-medium text-gray-700 mb-1">Seleccionar Paciente:</label>
                <select id="patientSelector" onchange="loadPatientData()" class="w-full p-2 border border-gray-300 rounded-lg"></select>
            </div>
            <div>
                <label for="paramSelector" class="block text-sm font-medium text-gray-700 mb-1">Parámetro a Graficar:</label>
                <select id="paramSelector" onchange="updateGraph()" class="w-full p-2 border border-gray-300 rounded-lg"></select>
            </div>
            <div class="flex flex-col justify-end space-y-2">
                <button onclick="generateHCLAB()" class="px-4 py-2 bg-yellow-500 text-white font-medium rounded-lg hover:bg-yellow-600 transition duration-150">Generar HCLAB (Salida Abreviada)</button>
                <button onclick="downloadCSV()" class="px-4 py-2 bg-purple-600 text-white font-medium rounded-lg hover:bg-purple-700 transition duration-150">Descargar CSV</button>
            </div>
        </div>

        <div id="hclabOutput" class="p-3 bg-blue-50 border border-blue-200 rounded-lg hidden"></div>
    </section>

    <!-- GRÁFICO DE EVOLUCIÓN -->
    <section class="mb-8 p-4 border rounded-lg">
        <h2 class="text-xl font-semibold mb-3 text-gray-700">3. Gráfico de Evolución Temporal</h2>
        <div class="bg-gray-100 p-4 rounded-lg">
            <canvas id="evolutionChart" width="800" height="300"></canvas>
        </div>
    </section>

    <!-- TABLA UCI -->
    <section class="p-4 border rounded-lg">
        <h2 class="text-xl font-semibold mb-3 text-gray-700">4. Tabla UCI (Todas las Variables por Muestra)</h2>
        <div id="uciTableContainer" class="overflow-x-auto max-h-96 border border-gray-300 rounded-lg">
            <table id="uciTable" class="min-w-full divide-y divide-gray-200 uci-table-fixed">
                <thead></thead>
                <tbody></tbody>
            </table>
        </div>
    </section>

</div>

<div id="loading" class="loading-overlay hidden">
    <div class="bg-white p-6 rounded-lg shadow-lg">
        <p class="text-xl text-blue-600">Procesando Laboratorio...</p>
    </div>
</div>

<script>
    // ====================================================================
    // CONFIGURACIÓN DE PARÁMETROS (Requerimiento 4.2 y JSON)
    // ====================================================================
    const PARAMETERS = {
        // Hematología
        "Hemoglobina": { synonyms: /(Hgb|Hemoglobina|HB|Hemog)/i, unit: 'g/dL', hclab: 'Hb' },
        "Hematocrito": { synonyms: /(Hct|Hematocrito|Hto)/i, unit: '%', hclab: 'Hto' },
        // Iones / electrolitos
        "Na": { synonyms: /(Na|Sodio|natremia)/i, unit: 'mEq/L', hclab: 'Na' },
        "K": { synonyms: /(K|Potasio|kalemia)/i, unit: 'mEq/L', hclab: 'K' },
        "Cl": { synonyms: /(Cl|Cloro|cloro|cloremia)/i, unit: 'mEq/L', hclab: 'Cl' },
        "Mg": { synonyms: /(Mg|Magnesio)/i, unit: 'mg/dL', hclab: 'Mg' },
        "Ca_Total": { synonyms: /(Ca\s*Total|Calcio\s*Total)/i, unit: 'mg/dL', hclab: 'CaT' },
        "Ca_Ionizado": { synonyms: /(Ca\s*Ionizado|Calcio\s*Ionizado)/i, unit: 'mmol/L', hclab: 'CaI' },
        // Metabolismo / Renal
        "Glucosa": { synonyms: /(Glucosa|Glu|Glicemia|Glc)/i, unit: 'mg/dL', hclab: 'Glu' },
        "Urea": { synonyms: /(Urea|Ureico|BUN)/i, unit: 'mg/dL', hclab: 'Urea' },
        "Creatinina": { synonyms: /(Creatinina|Cr|Crea)/i, unit: 'mg/dL', hclab: 'Cr' },
        "Acido_Urico": { synonyms: /(Ácido\s*Úrico|Acido\s*Urico)/i, unit: 'mg/dL', hclab: 'AU' },
        "Osmolalidad": { synonyms: /(Osmolalidad|Osmol)/i, unit: 'mOsm/Kg', hclab: 'Osm' },
        // Hepatograma
        "BT": { synonyms: /(BT|Bilirrubina\s*Total)/i, unit: 'mg/dL', hclab: 'BT' },
        "BD": { synonyms: /(BD|Bilirrubina\s*Directa)/i, unit: 'mg/dL', hclab: 'BD' },
        "AST_TGO": { synonyms: /(AST|TGO|Aspartato)/i, unit: 'U/L', hclab: 'AST' },
        "ALT_TGP": { synonyms: /(ALT|TGP|Alanina|GPT)/i, unit: 'U/L', hclab: 'ALT' },
        "Fosfatasa_Alcalina": { synonyms: /(Fosfatasa\s*Alcalina|FAL)/i, unit: 'U/L', hclab: 'FA' },
        "GGT": { synonyms: /(GGT|Gamma\s*Glutamil|GammaGT)/i, unit: 'U/L', hclab: 'GGT' },
        "Albúmina": { synonyms: /(Albumin|Albúmina)/i, unit: 'g/dL', hclab: 'Alb' },
        "Proteínas_Totales": { synonyms: /(Proteínas\s*Total|Prot\s*Total)/i, unit: 'g/dL', hclab: 'Prot' },
        // Perfil Lipídico
        "Colesterol_Total": { synonyms: /(Colesterol\s*Total|CT)/i, unit: 'mg/dL', hclab: 'CT' },
        "LDL": { synonyms: /(LDL|C\s*LDL)/i, unit: 'mg/dL', hclab: 'LDL' },
        "HDL": { synonyms: /(HDL|C\s*HDL)/i, unit: 'mg/dL', hclab: 'HDL' },
        "Triglicéridos": { synonyms: /(Triglicéridos|TGL|TG)/i, unit: 'mg/dL', hclab: 'TGL' },
        "Lipoproteína_a": { synonyms: /(Lipoproteína\s*\(a\)|Lp\(a\))/i, unit: 'mg/dL', hclab: 'Lpa' },
        "ApoB": { synonyms: /(ApoB|Apolipoproteína\s*B)/i, unit: 'mg/dL', hclab: 'ApoB' },
        // Marcadores de Inflamación
        "PCR": { synonyms: /(PCR|Proteína\s*C\s*Reactiva)/i, unit: 'mg/L', hclab: 'PCR' },
        "Procalcitonina": { synonyms: /(Procalcitonina|PCT)/i, unit: 'ng/ml', hclab: 'PCT' },
        "VSG": { synonyms: /(VSG|Velocidad\s*Sedimentación)/i, unit: 'mm/h', hclab: 'VSG' },
        "Ferritina": { synonyms: /(Ferritina)/i, unit: 'ng/ml', hclab: 'Ferr' },
        // Marcadores Cardíacos
        "CPK": { synonyms: /(CK|CPK|Creatinkinasa)/i, unit: 'U/L', hclab: 'CPK' },
        "CK_MB": { synonyms: /(CK\s*MB)/i, unit: 'ng/ml', hclab: 'CKMB' },
        "Troponina": { synonyms: /(Troponina\s*[TIi])/i, unit: 'ng/ml', hclab: 'Trop' },
        "NT_proBNP": { synonyms: /(NT-proBNP|BNP)/i, unit: 'pg/ml', hclab: 'BNP' },
        // Vitaminas / Hormonas
        "Vitamina_B12": { synonyms: /(Vitamina\s*B12|Cianocobalamina)/i, unit: 'pg/ml', hclab: 'B12' },
        "Acido_Fólico": { synonyms: /(Ácido\s*Fólico|Folato)/i, unit: 'ng/ml', hclab: 'Fol' },
        "TSH": { synonyms: /(TSH)/i, unit: 'uUI/ml', hclab: 'TSH' },
        "Cortisol": { synonyms: /(Cortisol)/i, unit: 'mcg/dL', hclab: 'Cort' },
        // Coagulación
        "TP": { synonyms: /(TP|Tiempo\s*Protrombina)/i, unit: '%', hclab: 'TP' },
        "INR": { synonyms: /(INR)/i, unit: '', hclab: 'INR' }, 
        "TTPA": { synonyms: /(TTPA|TTP)/i, unit: 's', hclab: 'TTPA' },
        "Fibrinógeno": { synonyms: /(Fibrinógeno|Fibrinogeno)/i, unit: 'mg/dL', hclab: 'Fib' },
        // Otros
        "Lactato": { synonyms: /(Lactato|Ácido\s*Láctico)/i, unit: 'mmol/L', hclab: 'Lact' },
    };

    // ====================================================================
    // REGEX DE UNIDADES FLEXIBLES (Requerimiento 4.3 - Tolerancia a OCR)
    // ====================================================================
    const UNIT_REGEX = {
        'U/L': '(U|UI)\\s*\\/?\\s*[L|l|1]|UI/l|U\\/L', 
        'mg/dL': 'mg\\/dl',
        'g/dL': 'g\\/dl',
        '%': '%',
        'mEq/L': 'mEq\\/[L|l|1]',
        'mmol/L': 'mmol\\/[L|l|1]',
        'ng/ml': 'ng\\/ml',
        'pg/ml': 'pg\\/ml',
        'ng/L': 'ng\\/L',
        'mm/h': 'mm\\/h',
        'mOsm/Kg': 'mOsm\\/Kg',
        'uUI/ml': 'uUI\\/ml',
        'mcg/dL': 'mcg\\/dl',
        's': 's',
        '': '\\s*$', 
    };

    // ====================================================================
    // ALMACENAMIENTO GLOBAL Y FUNCIONES DE PERSISTENCIA
    // ====================================================================
    let labData = {}; 
    let chartInstance = null;
    const LOCAL_STORAGE_KEY = 'uciLabMonitorData_V13';

    function saveData() {
        localStorage.setItem(LOCAL_STORAGE_KEY, JSON.stringify(labData));
    }

    function loadData() {
        const storedData = localStorage.getItem(LOCAL_STORAGE_KEY);
        if (storedData) {
            labData = JSON.parse(storedData);
        }
        loadPatientSelector();
    }

    // ====================================================================
    // FUNCIÓN CENTRAL DE PARSING ROBUSTO (Requerimiento 4.3 y 9)
    // ====================================================================
    
    /**
     * Captura un valor numérico asociado a un parámetro.
     */
    function parseLabValue(text, paramName, unitKey) {
        const unitPattern = UNIT_REGEX[unitKey] || 'mg\\/dl';
        const paramRegexSource = PARAMETERS[paramName].synonyms.source.source.replace(/\\/g, ''); 
        
        // La regex clave: Captura el valor que puede tener punto o coma, antes de la unidad.
        const masterRegex = new RegExp(
            `(${paramRegexSource})[\\s\\S]{0,250}?\s*([\\d\\.,]+)\\s*[↑↓]?\\s*(${unitPattern})`, 
            'im'
        );
        
        const match = text.match(masterRegex);

        if (match) {
            let value = match[2].replace(',', '.'); // Normalizar coma decimal a punto
            return parseFloat(value);
        }
        return null;
    }

    /**
     * Procesa el texto de entrada para extraer la metadata y todos los parámetros.
     */
    function processInput(text) {
        if (!text.trim()) {
            alert('Por favor, pegue el texto del laboratorio o cargue un PDF.');
            return;
        }
        
        // Reemplazar coma decimal por punto en TODO el texto antes de normalizar
        text = text.replace(/(\d),(\d)/g, '$1.$2'); 

        const normalizedText = text.replace(/(\n|\r)/g, ' ').toUpperCase();
        
        // 1. Extraer Metadata (Nombre, Protocolo, Fecha, Hora)
        const metadata = extractMetadata(normalizedText);
        if (!metadata.paciente) {
            alert('No se pudo identificar el Nombre del Paciente. La muestra no será guardada.');
            return;
        }

        let newSample = {
            ...metadata,
            parametros: {},
            timestamp: new Date(`${metadata.fecha}T${metadata.hora}`).getTime() 
        };

        // 2. Detección de Parámetros
        let detectedCount = 0;
        for (const paramName in PARAMETERS) {
            const { unit } = PARAMETERS[paramName];
            const value = parseLabValue(text, paramName, unit);
            
            if (value !== null && !isNaN(value)) {
                newSample.parametros[paramName] = value;
                detectedCount++;
            }
        }

        if (detectedCount === 0) {
            alert('Advertencia: No se detectó ningún parámetro válido en el texto. Revise el formato.');
            return;
        }

        // 3. Almacenamiento
        const patientName = newSample.paciente;
        if (!labData[patientName]) {
            labData[patientName] = [];
        }
        
        const isDuplicate = labData[patientName].some(sample => 
            sample.protocolo === newSample.protocolo && sample.fecha === newSample.fecha
        );

        if (!isDuplicate) {
            labData[patientName].push(newSample);
            labData[patientName].sort((a, b) => a.timestamp - b.timestamp); 
            saveData();
            alert(`Muestra de ${newSample.fecha} (${newSample.protocolo}) cargada exitosamente para ${patientName}. Parámetros detectados: ${detectedCount}`);
        } else {
            alert(`Muestra de ${newSample.fecha} (${newSample.protocolo}) ya existe o es duplicada. No se cargó.`);
        }
        
        loadPatientSelector(patientName); 
        loadPatientData();
        clearInput();
    }

    /**
     * Extrae Nombre, Protocolo, Fecha, y Hora del texto.
     */
    function extractMetadata(text) {
        const result = { paciente: null, protocolo: null, fecha: null, hora: '00:00:00' };

        const patientRegex = /(PACIENTE|NOMBRE|PT)\s*[:]?\s*([A-Z\s\.,]{5,})/i;
        let match = text.match(patientRegex);
        if (match) {
            result.paciente = match[2].trim().replace(/\s{2,}/g, ' ');
        }
        
        const protocolRegex = /(PROTOCOLO|ACCESSION|SOLICITUD)\s*[:]?\s*([A-Z0-9-]{4,})/i;
        match = text.match(protocolRegex);
        if (match) {
            result.protocolo = match[2].trim();
        }

        const dateRegex = /(\d{1,2}[\/\.-]\d{1,2}[\/\.-]\d{2,4})/;
        match = text.match(dateRegex);
        if (match) {
            const parts = match[1].split(/[\/\.-]/);
            if (parts.length === 3) {
                let day = parts[0].padStart(2, '0');
                let month = parts[1].padStart(2, '0');
                let year = parts[2].length === 2 ? `20${parts[2]}` : parts[2];
                result.fecha = `${year}-${month}-${day}`; 
            }
        }
        
        const timeRegex = /(\d{1,2}:\d{2})/;
        match = text.match(timeRegex);
        if (match) {
            result.hora = match[1] + ':00';
        } else if (result.fecha) {
            result.hora = '12:00:00'; 
        }

        return result;
    }

    // ====================================================================
    // FUNCIONALIDAD DE UI
    // ====================================================================

    function loadPatientSelector(selectPatient = null) {
        const selector = document.getElementById('patientSelector');
        selector.innerHTML = '<option value="">-- Seleccionar Paciente --</option>';
        const patientNames = Object.keys(labData).sort();
        patientNames.forEach(name => {
            const option = document.createElement('option');
            option.value = name;
            option.textContent = name;
            selector.appendChild(option);
        });
        
        if (selectPatient && patientNames.includes(selectPatient)) {
            selector.value = selectPatient;
        }

        if (patientNames.length === 0) {
            document.getElementById('paramSelector').innerHTML = '<option>-- No hay datos --</option>';
            document.getElementById('uciTable').querySelector('tbody').innerHTML = '<tr><td colspan="100" class="text-center py-4 text-gray-500">No hay datos cargados.</td></tr>';
        } else if (!selectPatient && selector.value) {
            // Si hay pacientes pero no se seleccionó uno nuevo, forzar la carga del paciente actual
            loadPatientData(); 
        }
    }

    function loadParamSelector() {
        const patientName = document.getElementById('patientSelector').value;
        const allParams = new Set();
        
        if (patientName && labData[patientName]) {
            labData[patientName].forEach(sample => {
                Object.keys(sample.parametros).forEach(param => allParams.add(param));
            });
        }

        const selector = document.getElementById('paramSelector');
        const currentParam = selector.value;
        selector.innerHTML = '';
        const sortedParams = Array.from(allParams).sort();

        sortedParams.forEach(param => {
            const option = document.createElement('option');
            option.value = param;
            option.textContent = param.replace(/_/g, ' ');
            selector.appendChild(option);
        });
        
        // Mantener el parámetro seleccionado o seleccionar el primero
        if (sortedParams.length > 0) {
            if (currentParam && sortedParams.includes(currentParam)) {
                selector.value = currentParam;
            } else {
                selector.value = sortedParams[0];
            }
        }
    }

    function loadPatientData() {
        const patientName = document.getElementById('patientSelector').value;
        const tableBody = document.getElementById('uciTable').querySelector('tbody');
        const tableHead = document.getElementById('uciTable').querySelector('thead');
        
        if (!patientName) {
            tableBody.innerHTML = '<tr><td colspan="100" class="text-center py-4 text-gray-500">Seleccione un paciente para ver el historial.</td></tr>';
            tableHead.innerHTML = '';
            if (chartInstance) chartInstance.destroy();
            return;
        }

        const samples = labData[patientName];
        if (!samples || samples.length === 0) {
             tableBody.innerHTML = '<tr><td colspan="100" class="text-center py-4 text-gray-500">No hay muestras cargadas para este paciente.</td></tr>';
             tableHead.innerHTML = '';
             if (chartInstance) chartInstance.destroy();
             return;
        }

        loadParamSelector();

        const allParams = new Set();
        samples.forEach(sample => {
            Object.keys(sample.parametros).forEach(param => allParams.add(param));
        });
        const sortedParams = Array.from(allParams).sort();

        let headHTML = `
            <tr>
                <th class="px-3 py-2 text-left text-xs font-bold text-gray-700 uppercase">Fecha/Hora</th>
                <th class="px-3 py-2 text-left text-xs font-bold text-gray-700 uppercase">Protocolo</th>
        `;
        sortedParams.forEach(param => {
            const unit = PARAMETERS[param]?.unit || 'un';
            headHTML += `<th class="px-3 py-2 text-center text-xs font-bold text-gray-700 uppercase">${param.replace(/_/g, ' ')} (${unit})</th>`;
        });
        headHTML += `</tr>`;
        tableHead.innerHTML = headHTML;

        let bodyHTML = '';
        samples.forEach(sample => {
            const dateObj = new Date(sample.fecha);
            const displayDate = dateObj.toLocaleDateString('es-AR', { day: '2-digit', month: 'short' });
            bodyHTML += `<tr class="hover:bg-gray-50">
                <td class="px-3 py-2 whitespace-nowrap text-sm text-gray-900">${displayDate} ${sample.hora.substring(0, 5)}</td>
                <td class="px-3 py-2 whitespace-nowrap text-xs text-gray-500">${sample.protocolo || 'N/A'}</td>`;
            
            sortedParams.forEach(param => {
                const value = sample.parametros[param] !== undefined ? sample.parametros[param] : '-';
                bodyHTML += `<td class="px-3 py-2 text-sm text-center">${value}</td>`;
            });
            bodyHTML += `</tr>`;
        });

        tableBody.innerHTML = bodyHTML;
        
        updateGraph();
    }

    // ARREGLO CRÍTICO: Eliminar el error 'getContext'
    function updateGraph() {
        const patientName = document.getElementById('patientSelector').value;
        const param = document.getElementById('paramSelector').value;
        const canvas = document.getElementById('evolutionChart');
        const ctx = canvas ? canvas.getContext('2d') : null; // Si el canvas es null, ctx será null
        
        // Destruir cualquier instancia previa si no hay un paciente válido o contexto.
        if (!patientName || !param || !ctx) {
            if (chartInstance) chartInstance.destroy();
            return;
        }

        const samples = labData[patientName];
        if (!samples) return;

        const dataPoints = samples
            .filter(s => s.parametros[param] !== undefined)
            .map(s => ({
                x: new Date(s.fecha + 'T' + s.hora).toLocaleString('es-AR', { day: '2-digit', month: 'short', hour: '2-digit', minute: '2-digit' }),
                y: s.parametros[param]
            }));

        const labels = dataPoints.map(dp => dp.x);
        const data = dataPoints.map(dp => dp.y);
        const unit = PARAMETERS[param]?.unit || '';

        if (chartInstance) chartInstance.destroy();

        chartInstance = new Chart(ctx, {
            type: 'line',
            data: {
                labels: labels,
                datasets: [{
                    label: `${param.replace(/_/g, ' ')} (${unit})`,
                    data: data,
                    borderColor: 'rgb(59, 130, 246)',
                    backgroundColor: 'rgba(59, 130, 246, 0.1)',
                    borderWidth: 2,
                    tension: 0.3,
                    pointRadius: 5
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    title: { display: true, text: `Evolución de ${param.replace(/_/g, ' ')}` }
                },
                scales: {
                    y: {
                        beginAtZero: false,
                        title: { display: true, text: `Valor (${unit})` }
                    },
                    x: {
                        title: { display: true, text: 'Fecha y Hora de Muestra' }
                    }
                }
            }
        });
    }

    function generateHCLAB() {
        const patientName = document.getElementById('patientSelector').value;
        if (!patientName) {
            alert('Por favor, seleccione un paciente.');
            return;
        }

        const samples = labData[patientName];
        if (!samples || samples.length === 0) return;
        
        const lastSample = samples[samples.length - 1];

        const hclabParts = [];
        const hclabKeysOrder = [
            'Na', 'K', 'Cl', 'Hemoglobina', 'Hematocrito', 'Glucosa', 'Urea', 'Creatinina', 
            'ALT_TGP', 'AST_TGO', 'BT', 'BD', 'Albúmina', 'Proteínas_Totales', 'CPK', 'PCR', 'INR', 'Lactato'
        ];

        hclabKeysOrder.forEach(paramName => {
            const hclabKey = PARAMETERS[paramName]?.hclab;
            const value = lastSample.parametros[paramName];
            
            if (hclabKey && value !== undefined) {
                hclabParts.push(`${hclabKey} ${value}`);
            }
        });

        const hclabString = hclabParts.join(', ');
        const outputDiv = document.getElementById('hclabOutput');
        
        outputDiv.innerHTML = `
            <p class="font-bold text-gray-800 mb-1">Salida HCLAB para Historia Clínica (Última Muestra):</p>
            <textarea id="hclabTextarea" class="w-full p-2 border rounded" rows="3" readonly>${hclabString}</textarea>
            <button onclick="copyToClipboard(document.getElementById('hclabTextarea').value)" class="mt-2 text-sm text-blue-600 hover:underline">Copiar al Portapapeles</button>
        `;
        outputDiv.classList.remove('hidden');
    }

    function downloadCSV() {
        const patientName = document.getElementById('patientSelector').value;
        if (!patientName) {
            alert('Por favor, seleccione un paciente para descargar.');
            return;
        }

        const samples = labData[patientName];
        if (!samples || samples.length === 0) return;

        const allParams = new Set();
        samples.forEach(sample => {
            Object.keys(sample.parametros).forEach(param => allParams.add(param));
        });
        const sortedParams = Array.from(allParams).sort();
        
        let csvContent = "Paciente,Protocolo,Fecha,Hora," + sortedParams.join(',') + "\n";

        samples.forEach(sample => {
            let row = `${sample.paciente},${sample.protocolo || 'N/A'},${sample.fecha},${sample.hora},`;
            sortedParams.forEach(param => {
                row += (sample.parametros[param] !== undefined ? sample.parametros[param] : '') + ',';
            });
            csvContent += row.slice(0, -1) + "\n"; 
        });

        const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement("a");
        link.setAttribute("href", URL.createObjectURL(blob));
        link.setAttribute("download", `LAB_UCI_${patientName.replace(/\s/g, '_')}.csv`);
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    }

    function clearInput() {
        document.getElementById('labInput').value = '';
        document.getElementById('hclabOutput').classList.add('hidden');
    }

    function copyToClipboard(text) {
        const textarea = document.createElement('textarea');
        textarea.value = text;
        document.body.appendChild(textarea);
        textarea.select();
        try {
            document.execCommand('copy');
            alert('Copiado al portapapeles!');
        } catch (err) {
            console.error('No se pudo copiar: ', err);
            alert('Error al copiar. Por favor, seleccione el texto manualmente.');
        }
        document.body.removeChild(textarea);
    }
    
    // ====================================================================
    // MANEJO DE PDF (Usando pdf.js)
    // ====================================================================

    function setupPdfHandling() {
        const pdfjsLib = window['pdfjs-dist/build/pdf'];
        if (pdfjsLib) {
            pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.13.216/pdf.worker.min.js';
        } else {
             console.error("PDF.js no está disponible. La carga de PDF no funcionará.");
             return;
        }
        
        document.getElementById('pdfInput').addEventListener('change', function(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = async function() {
                document.getElementById('loading').classList.remove('hidden');
                const pdfData = new Uint8Array(this.result);
                try {
                    const pdf = await pdfjsLib.getDocument({ data: pdfData }).promise;
                    let fullText = '';
                    for (let i = 1; i <= pdf.numPages; i++) {
                        const page = await pdf.getPage(i);
                        const textContent = await page.getTextContent();
                        fullText += textContent.items.map(item => item.str).join(' ') + '\n\n';
                    }
                    document.getElementById('labInput').value = fullText;
                    processInput(fullText);
                } catch (error) {
                    alert('Error al procesar el PDF. Revise la consola. Detalle: ' + error.message);
                } finally {
                    document.getElementById('loading').classList.add('hidden');
                }
            };
            reader.readAsArrayBuffer(file);
        });
    }

    // ====================================================================
    // INICIALIZACIÓN
    // ====================================================================
    document.addEventListener('DOMContentLoaded', () => {
        loadData();
        setupPdfHandling();
        // Carga inicial de datos (selecciona el primero si existe)
        const patientSelector = document.getElementById('patientSelector');
        if (patientSelector.options.length > 1) {
            patientSelector.value = patientSelector.options[1].value;
            loadPatientData();
        }
    });
</script>

<!-- Scripts de librerías externas -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.13.216/pdf.min.js"></script>

</body>
</html>
