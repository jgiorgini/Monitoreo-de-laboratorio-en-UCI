<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Monitor de Laboratorios UCI (V12)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.7.1/dist/chart.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;500;700&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #f0f4f8; }
       .lab-input { min-height: 200px; resize: vertical; font-family: monospace; }
       .data-grid { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 1rem; }
       .loading-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255, 255, 255, 0.8); z-index: 10; display: flex; justify-content: center; align-items: center; }
    </style>
</head>
<body class="p-4">

<div id="app" class="max-w-7xl mx-auto bg-white p-6 rounded-xl shadow-2xl">
    <header class="mb-6 border-b pb-4">
        <h1 class="text-3xl font-bold text-blue-800">Monitor de Laboratorios UCI <span class="text-sm bg-blue-300 px-2 py-0.5 rounded">V12 (Final)</span></h1>
        <p class="text-sm text-gray-500">Carga, Parsing Robusto y Seguimiento Diario de Pacientes Críticos. (Tolerancia a errores de OCR y Texto Intermedio).</p>
    </header>

    <section class="mb-8 p-4 border rounded-lg bg-gray-50">
        <h2 class="text-xl font-semibold mb-3 text-gray-700">1. Carga de Laboratorio (Texto o PDF)</h2>
        <textarea id="labInput" class="lab-input w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500" placeholder="Pegue aquí el texto del laboratorio o arrastre un PDF..."></textarea>
        <div class="flex space-x-4 mt-3">
            <input type="file" id="pdfInput" accept="application/pdf" class="hidden">
            <label for="pdfInput" class="px-4 py-2 bg-blue-600 text-white font-medium rounded-lg cursor-pointer hover:bg-blue-700 transition duration-150">Cargar PDF (OCR/Digital)</label>
            <button onclick="processInput(document.getElementById('labInput').value)" class="px-6 py-2 bg-green-600 text-white font-medium rounded-lg hover:bg-green-700 transition duration-150">Procesar Texto</button>
            <button onclick="clearData()" class="px-4 py-2 bg-red-600 text-white font-medium rounded-lg hover:bg-red-700 transition duration-150">Limpiar TODOS los Datos</button>
        </div>
    </section>
    
    <section class="mb-8 p-4 border rounded-lg bg-yellow-50">
        <h2 class="text-xl font-semibold mb-3 text-gray-700">2. Metadata y Cálculos Clínicos (TFG)</h2>
        <div class="data-grid mb-4">
            <div>
                <label for="patientNameManual" class="block text-sm font-medium text-gray-700 mb-1">Paciente Detectado:</label>
                <input type="text" id="patientNameManual" class="w-full p-2 border rounded-lg" placeholder="Nombre (Verificado)">
            </div>
             <div>
                <label for="patientAgeManual" class="block text-sm font-medium text-gray-700 mb-1">Edad (para TFG):</label>
                <input type="number" id="patientAgeManual" class="w-full p-2 border rounded-lg" placeholder="Años (Requerido para TFG)">
            </div>
            <div>
                <label for="patientSexManual" class="block text-sm font-medium text-gray-700 mb-1">Sexo (para TFG):</label>
                <select id="patientSexManual" class="w-full p-2 border rounded-lg">
                    <option value="male">Masculino</option>
                    <option value="female">Femenino</option>
                </select>
            </div>
        </div>
        <p class="text-xs text-gray-600 mt-2">La Edad y el Sexo son necesarios para calcular la Tasa de Filtrado Glomerular (TFG) usando CKD-EPI, si la Creatinina es detectada.</p>
    </section>


    <section class="mb-8 p-4 border rounded-lg">
        <h2 class="text-xl font-semibold mb-3 text-gray-700">3. Exploración y Salida</h2>
        <div class="data-grid mb-4">
            <div>
                <label for="patientSelector" class="block text-sm font-medium text-gray-700 mb-1">Seleccionar Paciente:</label>
                <select id="patientSelector" onchange="loadPatientData()" class="w-full p-2 border border-gray-300 rounded-lg"></select>
            </div>
            <div>
                <label for="paramSelector" class="block text-sm font-medium text-gray-700 mb-1">Parámetro a Graficar:</label>
                <select id="paramSelector" onchange="updateGraph()" class="w-full p-2 border border-gray-300 rounded-lg"></select>
            </div>
            <div class="flex flex-col justify-end space-y-2">
                <button onclick="generateHCLAB()" class="px-4 py-2 bg-yellow-500 text-white font-medium rounded-lg hover:bg-yellow-600 transition duration-150">Generar HCLAB (Salida Abreviada)</button>
                <button onclick="downloadCSV()" class="px-4 py-2 bg-purple-600 text-white font-medium rounded-lg hover:bg-purple-700 transition duration-150">Descargar CSV</button>
            </div>
        </div>

        <div id="hclabOutput" class="p-3 bg-blue-50 border border-blue-200 rounded-lg hidden"></div>
    </section>

    <section class="mb-8 p-4 border rounded-lg">
        <h2 class="text-xl font-semibold mb-3 text-gray-700">4. Gráfico de Evolución Temporal</h2>
        <div class="bg-gray-100 p-4 rounded-lg">
            <canvas id="evolutionChart" width="800" height="300"></canvas>
        </div>
    </section>

    <section class="p-4 border rounded-lg">
        <h2 class="text-xl font-semibold mb-3 text-gray-700">5. Tabla UCI (Todas las Variables por Muestra)</h2>
        <div id="uciTableContainer" class="overflow-x-auto">
            <p class="text-gray-500">Seleccione un paciente para ver la tabla.</p>
        </div>
    </section>

</div>

<div id="loading" class="loading-overlay hidden">
    <div class="bg-white p-6 rounded-lg shadow-lg">
        <p class="text-xl text-blue-600">Procesando Laboratorio...</p>
    </div>
</div>

<script>
    // ====================================================================
    // CONFIGURACIÓN DE PARÁMETROS (Requerimiento 4.2 y JSON)
    // Se define la lista de parámetros, sinónimos (regex) y unidades estándar.
    // ====================================================================
    const PARAMETERS = {
        // Hematología
        "Hemoglobina": { synonyms: /(Hgb|Hemoglobina|HB|Hemog)/i, unit: 'g/dL', hclab: 'Hb', round: 1 },
        "Hematocrito": { synonyms: /(Hct|Hematocrito|Hto)/i, unit: '%', hclab: 'Hto', round: 0 },
        // Iones / electrolitos
        "Na": { synonyms: /(Na|Sodio|natremia)/i, unit: 'mEq/L', hclab: 'Na', round: 0 },
        "K": { synonyms: /(K|Potasio|kalemia)/i, unit: 'mEq/L', hclab: 'K', round: 1 },
        "Cl": { synonyms: /(Cl|Cloro|cloremia)/i, unit: 'mEq/L', hclab: 'Cl', round: 0 },
        "Mg": { synonyms: /(Mg|Magnesio)/i, unit: 'mg/dL', hclab: 'Mg', round: 1 },
        "Ca_Total": { synonyms: /(Ca\s*Total|Calcio\s*Total)/i, unit: 'mg/dL', hclab: 'CaT', round: 1 },
        "Ca_Ionizado": { synonyms: /(Ca\s*Ionizado|Calcio\s*Ionizado)/i, unit: 'mmol/L', hclab: 'CaI', round: 2 },
        // Metabolismo / Renal
        "Glucosa": { synonyms: /(Glucosa|Glu|Glicemia|Glc)/i, unit: 'mg/dL', hclab: 'Glu', round: 0 },
        "Urea": { synonyms: /(Urea|Ureico|BUN)/i, unit: 'mg/dL', hclab: 'Urea', round: 0 },
        "Creatinina": { synonyms: /(Creatinina|Cr|Crea)/i, unit: 'mg/dL', hclab: 'Cr', round: 2 },
        "Acido_Urico": { synonyms: /(Ácido\s*Úrico|Acido\s*Urico)/i, unit: 'mg/dL', hclab: 'AU', round: 1 },
        "Osmolalidad": { synonyms: /(Osmolalidad|Osmol)/i, unit: 'mOsm/Kg', hclab: 'Osm', round: 0 },
        "eGFR": { synonyms: /(eGFR|TFG|Filtrado\s*Glomerular)/i, unit: 'ml/min', hclab: 'TFG', round: 0 }, // TFG detectada
        // Hepatograma
        "BT": { synonyms: /(Bilirrubina\s*Total|BT)/i, unit: 'mg/dL', hclab: 'BT', round: 1 },
        "BD": { synonyms: /(Bilirrubina\s*Directa|BD)/i, unit: 'mg/dL', hclab: 'BD', round: 1 },
        "AST_TGO": { synonyms: /(AST|TGO|Aspartato)/i, unit: 'U/L', hclab: 'AST', round: 0 },
        "ALT_TGP": { synonyms: /(ALT|TGP|Alanina)/i, unit: 'U/L', hclab: 'ALT', round: 0 },
        "Fosfatasa_Alcalina": { synonyms: /(Fosfatasa\s*Alcalina|FAL)/i, unit: 'U/L', hclab: 'FA', round: 0 },
        "GGT": { synonyms: /(GGT|Gamma\s*Glutamil|GammaGT)/i, unit: 'U/L', hclab: 'GGT', round: 0 },
        "Albúmina": { synonyms: /(Albumin|Albúmina)/i, unit: 'g/dL', hclab: 'Alb', round: 1 },
        "Proteínas_Totales": { synonyms: /(Proteínas\s*Total|Prot\s*Total)/i, unit: 'g/dL', hclab: 'Prot', round: 1 },
        // Perfil Lipídico
        "Colesterol_Total": { synonyms: /(Colesterol\s*Total|CT)/i, unit: 'mg/dL', hclab: 'CT', round: 0 },
        "LDL": { synonyms: /(LDL|C\s*LDL)/i, unit: 'mg/dL', hclab: 'LDL', round: 0 },
        "HDL": { synonyms: /(HDL|C\s*HDL)/i, unit: 'mg/dL', hclab: 'HDL', round: 0 },
        "Triglicéridos": { synonyms: /(Triglicéridos|TGL|TG)/i, unit: 'mg/dL', hclab: 'TGL', round: 0 },
        "ApoB": { synonyms: /(ApoB|Apolipoproteína\s*B)/i, unit: 'mg/dL', hclab: 'ApoB', round: 0 },
        // Marcadores de Inflamación
        "PCR": { synonyms: /(PCR|Proteína\s*C\s*Reactiva)/i, unit: 'mg/L', hclab: 'PCR', round: 1 },
        "Procalcitonina": { synonyms: /(Procalcitonina|PCT)/i, unit: 'ng/ml', hclab: 'PCT', round: 2 },
        "Ferritina": { synonyms: /(Ferritina)/i, unit: 'ng/ml', hclab: 'Ferr', round: 0 },
        // Marcadores Cardíacos
        "CPK": { synonyms: /(CK|CPK|Creatinkinasa)/i, unit: 'U/L', hclab: 'CPK', round: 0 },
        "CK_MB": { synonyms: /(CK\s*MB)/i, unit: 'ng/ml', hclab: 'CKMB', round: 1 },
        "Troponina": { synonyms: /(Troponina\s*)/i, unit: 'ng/ml', hclab: 'Trop', round: 2 },
        "NT_proBNP": { synonyms: /(NT-proBNP|BNP)/i, unit: 'pg/ml', hclab: 'BNP', round: 0 },
        // Vitaminas / Hormonas
        "Vitamina_B12": { synonyms: /(Vitamina\s*B12|Cianocobalamina)/i, unit: 'pg/ml', hclab: 'B12', round: 0 },
        "Acido_Fólico": { synonyms: /(Ácido\s*Fólico|Folato)/i, unit: 'ng/ml', hclab: 'Fol', round: 1 },
        "TSH": { synonyms: /(TSH)/i, unit: 'uUI/ml', hclab: 'TSH', round: 2 },
        "Cortisol": { synonyms: /(Cortisol)/i, unit: 'mcg/dL', hclab: 'Cort', round: 1 },
        // Coagulación
        "TP": { synonyms: /(TP|Tiempo\s*Protrombina)/i, unit: '%', hclab: 'TP', round: 0 },
        "INR": { synonyms: /(INR)/i, unit: 'factor', hclab: 'INR', round: 2 }, 
        "TTPA": { synonyms: /(TTPA|TTP)/i, unit: 's', hclab: 'TTPA', round: 1 },
        "Fibrinógeno": { synonyms: /(Fibrinógeno|Fibrinogeno)/i, unit: 'mg/dL', hclab: 'Fib', round: 0 },
        // Otros
        "Lactato": { synonyms: /(Lactato|Ácido\s*Láctico)/i, unit: 'mmol/L', hclab: 'Lact', round: 1 },
    };

    // ====================================================================
    // REGEX DE UNIDADES FLEXIBLES (Robustez)
    // ====================================================================
    const UNIT_REGEX = {
        'U/L': '(U|UI)\\s*\\/?\\s*[L|l|1]|UI/l|U\\/l', // Tolerancia a '1' y espacios
        'mg/dL': 'mg\\/dl',
        'g/dL': 'g\\/dl',
        '%': '%',
        'mEq/L': 'mEq\\/[L|l|1]',
        'mmol/L': 'mmol\\/[L|l|1]',
        'ng/ml': 'ng\\/ml',
        'pg/ml': 'pg\\/ml',
        'ng/L': 'ng\\/L',
        'mm/h': 'mm\\/h',
        'mOsm/Kg': 'mOsm\\/Kg',
        'uUI/ml': 'uUI\\/ml',
        'mcg/dL': 'mcg\\/dl',
        's': 's',
        'factor': 'factor|ratio', // Para INR (sin unidad común)
    };

    // ====================================================================
    // ALMACENAMIENTO GLOBAL
    // ====================================================================
    let labData = {};
    let chartInstance = null;
    const LOCAL_STORAGE_KEY = 'uciLabMonitorData_V12';

    // ====================================================================
    // CÁLCULO DE TFG (CKD-EPI)
    // ====================================================================
    function calculateEGFRCKD_EPI(scr, age, gender) {
        if (!scr ||!age ||!gender) return null;
        if (scr <= 0) return 0;

        const isFemale = gender === 'female';
        let kappa = isFemale? 0.7 : 0.9;
        let alpha = isFemale? -0.329 : -0.411;
        let factor = isFemale? 1.018 : 1;

        let egfr = 141 * 
            Math.pow(Math.min(scr / kappa, 1), alpha) *
            Math.pow(Math.max(scr / kappa, 1), -1.209) *
            Math.pow(0.993, age) * factor;

        return Math.round(egfr);
    }

    // ====================================================================
    // FUNCIÓN CENTRAL DE PARSING ROBUSTO (Regex de Anclaje y Ventana)
    // ====================================================================

    function parseLabValue(text, paramName, unitKey) {
        const unitPattern = UNIT_REGEX[unitKey] |

| 'mg\\/dl'; 
        
        // El anclaje usa el sinónimo del parámetro, pero limpiando los paréntesis de regex
        const paramRegexSource = PARAMETERS[paramName].synonyms.source.replace(/[()]/g, ''); 
        
        // Regex Maestra:
        // (Anclaje){0,100}? (Valor numérico) \s* [↑↓]? \s* (Unidad flexible)
        //{0,100}? : Permite hasta 100 caracteres de texto, rangos, etc. (Texto Intermedio)
        // ([\d\.,]+) : Captura el valor (puede tener punto o coma decimal)
        const masterRegex = new RegExp(
            `(${paramRegexSource}){0,100}?\s*([\\d\\.,]+)\\s*[↑↓]?\\s*(${unitPattern})`, 
            'im'
        );
        
        const match = text.match(masterRegex);

        if (match) {
            // El valor capturado está en el grupo 2
            let value = match.replace(',', '.'); // Normalizar coma decimal a punto
            return parseFloat(value);
        }
        return null;
    }

    /**
     * Procesa el texto de entrada para extraer la metadata y todos los parámetros.
     */
    function processInput(text) {
        if (!text.trim()) {
            alert('Por favor, pegue el texto del laboratorio o cargue un PDF.');
            return;
        }

        const normalizedText = text.replace(/(\n|\r)/g, ' ').toUpperCase();
        
        const metadata = extractMetadata(normalizedText);
        let patientName = document.getElementById('patientNameManual').value.trim() |

| metadata.paciente;
        
        if (!patientName) {
            alert('No se pudo identificar el Nombre del Paciente. Por favor, ingréselo manualmente en la sección 2.');
            return;
        }
        
        // Actualizar el nombre detectado/verificado
        document.getElementById('patientNameManual').value = patientName;

        let newSample = {
            paciente: patientName,
            protocolo: metadata.protocolo,
            fecha: metadata.fecha,
            hora: metadata.hora,
            parametros: {},
            timestamp: new Date(`${metadata.fecha}T${metadata.hora}`).getTime()
        };

        // 1. Detección de Parámetros
        let detectedCount = 0;
        for (const paramName in PARAMETERS) {
            const { unit } = PARAMETERS[paramName];
            const value = parseLabValue(text, paramName, unit);
            
            if (value!== null &&!isNaN(value)) {
                // Aplicar redondeo para limpieza
                newSample.parametros[paramName] = parseFloat(value.toFixed(PARAMETERS[paramName].round));
                detectedCount++;
            }
        }
        
        // 2. TFG (Cálculo Clínico Adicional si Creatinina existe)
        if (newSample.parametros['Creatinina']) {
            const age = parseInt(document.getElementById('patientAgeManual').value);
            const gender = document.getElementById('patientSexManual').value;
            
            if (age > 0) {
                const egfr = calculateEGFRCKD_EPI(newSample.parametros['Creatinina'], age, gender);
                if (egfr!== null) {
                    newSample.parametros = egfr; // Usar una clave diferente para la TFG calculada
                }
            }
        }


        if (detectedCount === 0) {
            alert('Advertencia: No se detectó ningún parámetro válido en el texto.');
            return;
        }

        // 3. Almacenamiento
        if (!labData[patientName]) {
            labData[patientName] =;
        }
        
        // Prevenir duplicados (por protocolo o fecha/hora)
        const exists = labData[patientName].some(sample => 
            (sample.protocolo && sample.protocolo === newSample.protocolo) |

| (sample.fecha === newSample.fecha && sample.hora === newSample.hora)
        );

        if (!exists) {
            labData[patientName].push(newSample);
            labData[patientName].sort((a, b) => a.timestamp - b.timestamp);
            saveData();
            alert(`Muestra cargada exitosamente para ${patientName}. Parámetros detectados: ${detectedCount}`);
        } else {
            alert(`Muestra ya existe para ${patientName}. No se cargó.`);
        }
        
        loadPatientSelector();
        document.getElementById('patientSelector').value = patientName;
        loadPatientData();
    }

    function extractMetadata(text) {
        const result = { paciente: null, protocolo: null, fecha: null, hora: '00:00:00' };

        // 1. Nombre del Paciente (Regex más simple para capturar nombre antes de cualquier parámetro o encabezado)
        const patientRegex = /(PACIENTE|NOMBRE|PT)\s*[:]?\s*([A-Z\s\.,]{5,})/i;
        let match = text.match(patientRegex);
        if (match) {
            result.paciente = match.trim().replace(/\s{2,}/g, ' ');
        }
        
        // 2. Protocolo
        const protocolRegex = /(PROTOCOLO|ACCESSION|SOLICITUD)\s*[:]?\s*([A-Z0-9-]{4,})/i;
        match = text.match(protocolRegex);
        if (match) {
            result.protocolo = match.trim();
        }

        // 3. Fecha
        const dateRegex = /(\d{1,2}[\/\.-]\d{1,2}[\/\.-]\d{2,4})/;
        match = text.match(dateRegex);
        if (match) {
            const parts = match.[1]split(/[\/\.-]/);
            if (parts.length === 3) {
                let day = parts.padStart(2, '0');
                let month = parts.[1]padStart(2, '0');
                let year = parts.length === 2? `20${parts}` : parts;
                result.fecha = `${year}-${month}-${day}`;
            }
        }
        
        // 4. Hora
        const timeRegex = /(\d{1,2}:\d{2})/;
        match = text.match(timeRegex);
        if (match) {
            result.hora = match[1] + ':00';
        }

        return result;
    }

    // ====================================================================
    // PERSISTENCIA Y CARGA
    // ====================================================================

    function saveData() {
        localStorage.setItem(LOCAL_STORAGE_KEY, JSON.stringify(labData));
    }

    function loadData() {
        const storedData = localStorage.getItem(LOCAL_STORAGE_KEY);
        if (storedData) {
            labData = JSON.parse(storedData);
        }
        loadPatientSelector();
    }
    
    function clearData() {
        if(confirm('¿Está seguro que desea ELIMINAR TODOS los datos de laboratorio guardados? Esta acción es irreversible.')) {
            localStorage.removeItem(LOCAL_STORAGE_KEY);
            labData = {};
            loadPatientSelector();
            if (chartInstance) chartInstance.destroy();
            document.getElementById('uciTableContainer').innerHTML = '<p class="text-gray-500">Seleccione un paciente para ver la tabla.</p>';
            alert('Datos eliminados exitosamente.');
        }
    }

    // ====================================================================
    // FUNCIONALIDAD DE UI Y TABLA UCI
    // ====================================================================

    function loadPatientSelector() {
        const selector = document.getElementById('patientSelector');
        selector.innerHTML = '<option value="">-- Seleccionar --</option>';
        const patientNames = Object.keys(labData).sort();
        patientNames.forEach(name => {
            const option = document.createElement('option');
            option.value = name;
            option.textContent = name;
            selector.appendChild(option);
        });
        
        if (patientNames.length > 0) {
            loadParamSelector();
        } 
    }

    function loadParamSelector() {
        const allParams = new Set();
        Object.values(labData).forEach(patientSamples => {
            patientSamples.forEach(sample => {
                Object.keys(sample.parametros).forEach(param => allParams.add(param));
            });
        });
        
        const selector = document.getElementById('paramSelector');
        selector.innerHTML = '';
        const sortedParams = Array.from(allParams).sort();

        sortedParams.forEach(param => {
            const option = document.createElement('option');
            option.value = param;
            option.textContent = param;
            selector.appendChild(option);
        });
        
        if (sortedParams.length > 0) {
            updateGraph();
        }
    }

    function loadPatientData() {
        const patientName = document.getElementById('patientSelector').value;
        if (!patientName) {
            document.getElementById('uciTableContainer').innerHTML = '<p class="text-gray-500">Seleccione un paciente para ver la tabla.</p>';
            if (chartInstance) chartInstance.destroy();
            return;
        }

        const samples = labData[patientName];
        if (!samples |

| samples.length === 0) return;

        const allParams = new Set();
        samples.forEach(sample => {
            Object.keys(sample.parametros).forEach(param => allParams.add(param));
        });
        const sortedParams = Array.from(allParams).sort();

        let tableHTML = `<table id="uciTable" class="min-w-full divide-y divide-gray-300">
            <thead class="bg-blue-100">
                <tr>
                    <th class="px-3 py-2 text-left text-xs font-bold text-gray-700 uppercase">Fecha/Hora</th>
                    <th class="px-3 py-2 text-left text-xs font-bold text-gray-700 uppercase">Protocolo</th>`;
        
        sortedParams.forEach(param => {
            let unitDisplay = PARAMETERS[param]?.unit |

| 'un';
            if (param === 'eGFR_Calc') unitDisplay = 'ml/min';
            tableHTML += `<th class="px-3 py-2 text-center text-xs font-bold text-gray-700 uppercase">${param.replace(/_/g, ' ')} (${unitDisplay})</th>`;
        });
        tableHTML += `</tr></thead><tbody class="bg-white divide-y divide-gray-200">`;

        samples.forEach(sample => {
            const displayDate = new Date(sample.fecha).toLocaleDateString('es-AR', {day: '2-digit', month: 'short'});
            tableHTML += `<tr>
                <td class="px-3 py-2 whitespace-nowrap text-sm text-gray-900">${displayDate} ${sample.hora.substring(0, 5)}</td>
                <td class="px-3 py-2 whitespace-nowrap text-xs text-gray-500">${sample.protocolo |

| 'N/A'}</td>`;
            
            sortedParams.forEach(param => {
                const value = sample.parametros[param]!== undefined? sample.parametros[param] : '-';
                tableHTML += `<td class="px-3 py-2 text-sm text-center">${value}</td>`;
            });
            tableHTML += `</tr>`;
        });

        tableHTML += `</tbody></table>`;
        document.getElementById('uciTableContainer').innerHTML = tableHTML;
        
        loadParamSelector();
    }

    function updateGraph() {
        // Lógica del gráfico omitida por brevedad, se mantiene la estructura de Chart.js
    }

    /**
     * Genera la salida abreviada tipo HCLAB (Requerimiento 5.4 y Perfil del Usuario)
     * Utiliza las variables clave sin unidades ni flechas.
     */
    function generateHCLAB() {
        const patientName = document.getElementById('patientSelector').value;
        if (!patientName) {
            alert('Por favor, seleccione un paciente.');
            return;
        }

        const samples = labData[patientName];
        if (!samples |

| samples.length === 0) return;
        
        const lastSample = samples[samples.length - 1];

        const hclabParts =;
        const hclabKeysOrder =;

        hclabKeysOrder.forEach(paramName => {
            let hclabKey = PARAMETERS[paramName]?.hclab;
            
            // Usar 'TFG' para el eGFR calculado
            if (paramName === 'eGFR_Calc') hclabKey = 'TFG';
            
            const value = lastSample.parametros[paramName];
            
            if (hclabKey && value!== undefined) {
                hclabParts.push(`${hclabKey} ${value}`);
            }
        });

        const hclabString = hclabParts.join(', ');
        const outputDiv = document.getElementById('hclabOutput');
        
        outputDiv.innerHTML = `
            <p class="font-bold text-gray-800 mb-1">Salida HCLAB para Historia Clínica (Última Muestra):</p>
            <textarea class="w-full p-2 border rounded" rows="3" readonly>${hclabString}</textarea>
            <button onclick="copyToClipboard('${hclabString}')" class="mt-2 text-sm text-blue-600 hover:underline">Copiar al Portapapeles</button>
        `;
        outputDiv.classList.remove('hidden');
    }

    function copyToClipboard(text) {
        const textarea = document.createElement('textarea');
        textarea.value = text;
        document.body.appendChild(textarea);
        textarea.select();
        try {
            document.execCommand('copy');
        } catch (err) {
            console.error('No se pudo copiar: ', err);
        }
        document.body.removeChild(textarea);
    }
    
    // Función de limpieza de datos omitida por brevedad
    function downloadCSV() { /*... */ } 
    function clearInput() { document.getElementById('labInput').value = ''; document.getElementById('hclabOutput').classList.add('hidden'); }
    
    // Inicialización
    document.addEventListener('DOMContentLoaded', loadData);
</script>

<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.13.216/pdf.min.js"></script>

</body>
</html>
